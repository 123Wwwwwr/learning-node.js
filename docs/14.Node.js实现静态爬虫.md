# Node.js 实现静态爬虫
> 爬虫是学习一门后端语言，所必备的技能之一。因此，这里带领大家来真正的实现一个静态爬虫的效果。

### 环境搭建
1. 创建项目目录 `static-spider-node`
    ```
    mkdir static-spider-node
    ```

2. 在环境中添加必要的依赖 `request`、`cheerio`
    初始化 `npm`，生成 `package.json`

    ```
    npm init
    ```
    添加依赖 `request`及 `cheerio`

    ```
    npm install --save request cheerio
    ```

### 实战

环境搭建完成后，开始真正的爬虫内容的编写

本教程获取的是 [知乎日报](http://daily.zhihu.com/) 首页的所有数据的图片内容，仅供学习使用，请勿用于商业用途

1. 进入项目目录，在项目目录中，创建一个 `spider.js`

   ```
   cd static-spider-node
   touch spider.js
   ```

2. 在 `spider.js` 中编写如下代码

   ```
   var request = require('request')
   request.get('http://daily.zhihu.com/', function (error, response, data) {
       console.log(data)
   })
   ```

   上述代码含义是通过 `request` 请求数据，获取首页的HTML代码

   打印结果如下:

   ```
   <!DOCTYPE html>
   <html lang="zh-CN">
   <head><title>知乎日报 - 每天 3 次，每次 7 分钟</title>
       <meta charset="utf-8">
       <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
       <meta name="description" content="在中国，资讯类移动应用的人均阅读时长是 5 分钟，而在知乎日报，这个数字是 21。以独有的方式为你提供最高质、最深度、最有收获的阅读体验。">
       <link rel="stylesheet" href="/css/base.auto.css">
       <link rel="stylesheet" href="/css/new_home_v3.auto.css">
       <script src="/js/jquery.1.9.1.js"></script>
       <script src="/js/new_index_v3/home.js"></script>
       <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
       <base target="_blank">
       <style>h1, h2, h3 {
           padding: 0;
           margin: 0
       }</style>
       <base target="_blank">
   </head>
   <body class="home"><a href="javascript:;" title="回到顶部" class="back-to-top"></a>
   <div class="header navbar-fixed-top">
       <div class="container-fixed-width clearfix">
           <div class="top-nav-link"><a href="javascript:;" data-offset="470"><span>浏览内容</span></a><a href="javascript:;"
                                                                                                      data-offset="0"
                                                                                                      class="active"><span>App 下载</span></a>
           </div>
           <h1 class="logo"><a href="http://daily.zhihu.com/" title="知乎日报" class="link-logo">知乎日报</a></h1></div>
   </div>
   <div class="download">
       <div class="container-fixed-width">
           <div class="sample-wrap"><img src="/img/new_home_v3/phone_sample.png" alt="知乎日报应用截屏" class="sample"></div>
           <div class="inner"><h2>每天三次 每次七分钟</h2>
               <div class="info">在中国，资讯类移动应用的人均阅读时长是 5 分钟，而在知乎日报，这个数字是 21。</div>
               <div class="qr-top"><img src="/img/new_home_v3/qr_top2.png"></div>
               <div class="link-buttons">
                   <ul class="donwload-links">
                       <li><a href="https://itunes.apple.com/cn/app/id639087967?mt=8" title="前往 App Store 下载"
                              data-device="iOS" class="iphone"><i class="icon"></i><span>iOS 版</span></a></li>
                       <li class="with-drop-menu"><a
                               href="http://zhstatic.zhihu.com/pkg/store/daily/zhihu-daily-zhihu-2.5.4(392).apk"
                               title="Android 版（本地下载）" data-device="android-local" class="android"><i
                               class="icon"></i><span>Android 版</span></a>
                           <ul>
                               <li><a href="http://www.wandoujia.com/apps/com.zhihu.daily.android" title="通过豌豆荚下载"
                                      name="知乎日报" onclick="return wdapi_apkdl_m(this, 'source');"
                                      data-device="android-wandoujia" class="wandoujia"><i
                                       class="icon"></i><span>豌豆荚</span></a></li>
                               <li>
                                   <a href="http://apk.hiapk.com/html/2013/09/1752117.html?p=iphone&amp;amp;f_name=%u77E5%u4E4E%u65E5%u62A5&amp;amp;f_version="
                                      title="通过 91 助手下载" name="知乎日报" onclick="return Key.Open(this,'iphone');"
                                      data-device="android-91" class="market91"><i class="icon"></i><span>91 市场</span></a>
                               </li>
                               <li><a href="http://zhushou.360.cn/detail/index/soft_id/348684" title="前往 360 手机助手下载"
                                      data-device="android-360" class="market360"><i
                                       class="icon"></i><span>360 市场</span></a></li>
                           </ul>
                       </li>
                   </ul>
               </div>
           </div>
       </div>
   </div>
   <div class="main-content">
       <div class="container-fixed-width">
           <div class="section-head">
               <div class="tip">最新内容</div>
               <div class="section-head-title">浏览内容</div>
           </div>
           <div class="main-content-wrap">
               <div class="row">
                   <div class="col-lg-4">
                       <div class="wrap">
                           <div class="box"><a href="/story/9575063" class="link-button"><img
                                   src="https://pic3.zhimg.com/v2-59b4550c7b511c8f043e4212b2712482.jpg"
                                   class="preview-image"><span class="title">小时候只觉得停电很好玩，却没想过为什么大家会一起停电</span></a></div>
                       </div>
                       <div class="wrap">
                           <div class="box"><a href="/story/9574987" class="link-button"><img
                                   src="https://pic1.zhimg.com/v2-a1068670e6cc3dc39c735cc048fc2f34.jpg"
                                   class="preview-image"><span class="title">VR 戒毒分三步：诱发、厌恶、回归，他们的人生，也是这三步</span></a></div>
                       </div>
                       <div class="wrap">
                           <div class="box"><a href="/story/9574273" class="link-button"><img
                                   src="https://pic3.zhimg.com/v2-2fa3ebefdf1fc288969c6d46d5c999de.jpg"
                                   class="preview-image"><span class="title">法院说：都别争了，王老吉和加多宝，你们共享红罐包装吧</span></a></div>
                       </div>
                       <div class="wrap">
                           <div class="box"><a href="/story/9570763" class="link-button"><img
                                   src="https://pic2.zhimg.com/v2-0a69950227b18eb768a07c999c4c6d15.jpg"
                                   class="preview-image"><span class="title">一家快挂了的公司如何起死回生？这是一段你能看懂的商业传奇</span></a></div>
                       </div>
                       <div class="wrap">
                           <div class="box"><a href="/story/9573354" class="link-button"><img
                                   src="https://pic1.zhimg.com/v2-7c6e8fb59f2c97d3663cf895d2fee4b8.jpg"
                                   class="preview-image"><span class="title">大误 · 樱木家真的很穷吗？</span></a></div>
                       </div>
                       <div class="wrap">
                           <div class="box"><a href="/story/9573724" class="link-button"><img
                                   src="https://pic4.zhimg.com/v2-6ac10da33fc50a3531db9498937bb11f.jpg"
                                   class="preview-image"><span class="title">想和好哥们一起创业，这件事必须谈妥了</span></a></div>
                       </div>
                       <div class="wrap">
                           <div class="box"><a href="/story/9573761" class="link-button"><img
                                   src="https://pic2.zhimg.com/v2-c1d9706c94dd45d1d1488edde56218fd.jpg"
                                   class="preview-image"><span class="title">《火影忍者》中角色的名字，原来是有特殊含义的</span></a></div>
                       </div>
                       <div class="wrap">
                           <div class="box"><a href="/story/9574487" class="link-button"><img
                                   src="https://pic4.zhimg.com/v2-47edb8fd14ca3b4427906ca89f2818e3.jpg"
                                   class="preview-image"><span class="title">假设《泰坦尼克号》事件现在发生，我们能把人救出来吗？</span></a></div>
                       </div>
                       <div class="wrap">
                           <div class="box"><a href="/story/9570680" class="link-button"><img
                                   src="https://pic2.zhimg.com/v2-06c9e55ac3df4eb121301d8dee04a4d9.jpg"
                                   class="preview-image"><span class="title">别觉得浮潜很简单，不做好功课都是生命的代价</span></a></div>
                       </div>
                       <div class="wrap">
                           <div class="box"><a href="/story/9574572" class="link-button"><img
                                   src="https://pic2.zhimg.com/v2-8616f8e57ec6614cba069c005c831a35.jpg"
                                   class="preview-image"><span class="title">越野跑大概是跑步的终极版本，最终回归原始</span></a></div>
                       </div>
                   </div>
                   <div class="col-lg-4">
                       <div class="wrap">
                           <div class="box"><a href="/story/9573414" class="link-button"><img
                                   src="https://pic1.zhimg.com/v2-c359b0616096ccb1810a8afaaf8810b0.jpg"
                                   class="preview-image"><span class="title">如果巴赫、贝多芬（没耳聋）、莫扎特还活着，他们会喜欢摇滚乐吗？</span></a>
                           </div>
                       </div>
                       <div class="wrap">
                           <div class="box"><a href="/story/9574031" class="link-button"><img
                                   src="https://pic2.zhimg.com/v2-71ef663585467c1be2366de56b38350d.jpg"
                                   class="preview-image"><span class="title">未来几年，这块市场会越来越大，就像当年的美国一样</span></a></div>
                       </div>
                       <div class="wrap">
                           <div class="box"><a href="/story/9572913" class="link-button"><img
                                   src="https://pic3.zhimg.com/v2-4b6f359b4cea284b3c74c69da28a61e2.jpg"
                                   class="preview-image"><span class="title">瞎扯 · 如何正确地吐槽</span></a></div>
                       </div>
                       <div class="wrap">
                           <div class="box"><a href="/story/9571856" class="link-button"><img
                                   src="https://pic1.zhimg.com/v2-dd1f5e941c31e417f7bdcc0099240498.jpg"
                                   class="preview-image"><span class="title">小事 · 汗滴瓜下土，颗颗皆辛苦</span></a></div>
                       </div>
                       <div class="wrap">
                           <div class="box"><a href="/story/9573752" class="link-button"><img
                                   src="https://pic3.zhimg.com/v2-344d208a3b884ce5f78872bcc38678fa.jpg"
                                   class="preview-image"><span class="title">她们不是所谓的「慰安妇」</span></a></div>
                       </div>
                       <div class="wrap">
                           <div class="box"><a href="/story/9572579" class="link-button"><img
                                   src="https://pic4.zhimg.com/v2-f6c6903f893f62d945ea3b8f9a8fbaf7.jpg"
                                   class="preview-image"><span class="title">小说中好多精彩情节《权力的游戏》都给删了，太可惜了</span></a></div>
                       </div>
                       <div class="wrap">
                           <div class="box"><a href="/story/9573980" class="link-button"><img
                                   src="https://pic3.zhimg.com/v2-e95230ba55aa581e02b681321a3cf2e6.jpg"
                                   class="preview-image"><span class="title">为什么济南地铁被称为「全球建设地铁难度最大」？</span></a></div>
                       </div>
                       <div class="wrap">
                           <div class="box"><a href="/story/9572318" class="link-button"><img
                                   src="https://pic1.zhimg.com/v2-675b9399c99bafd3a73e8c27b759bb30.jpg"
                                   class="preview-image"><span class="title">本来想遮掉肉肉，看着却像胖了十斤……夏天到底该怎么穿？</span></a></div>
                       </div>
                       <div class="wrap">
                           <div class="box"><a href="/story/9573831" class="link-button"><img
                                   src="https://pic4.zhimg.com/v2-210fc543b00744bc05f1c1af8db1a32b.jpg"
                                   class="preview-image"><span class="title">台湾突发史上最大规模停电，这口「锅」该谁背？</span></a></div>
                       </div>
                       <div class="wrap">
                           <div class="box"><a href="/story/9572273" class="link-button"><img
                                   src="https://pic4.zhimg.com/v2-094f4695ba64202f8d3e1a19af9ee987.jpg"
                                   class="preview-image"><span class="title">当初以为所有叫「运营」的工作都一样，难怪现在这么憋屈</span></a></div>
                       </div>
                   </div>
                   <div class="col-lg-4">
                       <div class="wrap">
                           <div class="box"><a href="/story/9573667" class="link-button"><img
                                   src="https://pic3.zhimg.com/v2-b41ee58e060428cdc169f4297632cdde.jpg"
                                   class="preview-image"><span class="title">你相信有上帝 / 神灵 / 鬼魂 / 佛的存在吗？</span></a></div>
                       </div>
                       <div class="wrap">
                           <div class="box"><a href="/story/9572881" class="link-button"><img
                                   src="https://pic2.zhimg.com/v2-9a1f2d5ffa76b8870daee9fee9fe8079.jpg"
                                   class="preview-image"><span class="title">看起来简单的跳绳，想要用来健身还有很多门道</span></a></div>
                       </div>
                       <div class="wrap">
                           <div class="box"><a href="/story/9572271" class="link-button"><img
                                   src="https://pic1.zhimg.com/v2-6a189ac9a6a7187754cf9a5f88458448.jpg"
                                   class="preview-image"><span class="title">有了高铁和互联网，你会从一线城市回到三四线城市吗？</span></a></div>
                       </div>
                       <div class="wrap">
                           <div class="box"><a href="/story/9572808" class="link-button"><img
                                   src="https://pic2.zhimg.com/v2-2a22a95347df1bb2accc90e507852235.jpg"
                                   class="preview-image"><span class="title">大误 · 40 级地震强度有多大？</span></a></div>
                       </div>
                       <div class="wrap">
                           <div class="box"><a href="/story/9572835" class="link-button"><img
                                   src="https://pic4.zhimg.com/v2-55740813f4d1ad8e1039a59f605c6a4b.jpg"
                                   class="preview-image"><span class="title">「老板如果你再不给我加薪的话，我就要离职了」</span></a></div>
                       </div>
                       <div class="wrap">
                           <div class="box"><a href="/story/9572584" class="link-button"><img
                                   src="https://pic1.zhimg.com/v2-413ede4ce86c544094d40b8a949f87c0.jpg"
                                   class="preview-image"><span class="title">服了，iTunes 为什么那么难用？</span></a></div>
                       </div>
                       <div class="wrap">
                           <div class="box"><a href="/story/9567157" class="link-button"><img
                                   src="https://pic4.zhimg.com/v2-e3ba76f3a723354a77ab24b2a883fb37.jpg"
                                   class="preview-image"><span class="title">「真正牛掰的人都很低调」，背后的逻辑是什么？</span></a></div>
                       </div>
                       <div class="wrap">
                           <div class="box"><a href="/story/9572874" class="link-button"><img
                                   src="https://pic2.zhimg.com/v2-b146b4bcddd4a51ac53b356e0de5dd6d.jpg"
                                   class="preview-image"><span class="title">现在回头看，才更加感叹「中国队长」蔡赟是怎样的传奇</span></a></div>
                       </div>
                       <div class="wrap">
                           <div class="box"><a href="/story/9572871" class="link-button"><img
                                   src="https://pic1.zhimg.com/v2-a5807b177f02f8b5c3da8db97ad47878.jpg"
                                   class="preview-image"><span class="title">明明昨天出了一身汗，这个 T 恤闻起来还能接着穿</span></a></div>
                       </div>
                       <div class="wrap">
                           <div class="box"><a href="/story/9572197" class="link-button"><img
                                   src="https://pic1.zhimg.com/v2-03435742ea04ac2d4520490f35dfcde8.jpg"
                                   class="preview-image"><span class="title">除了小黄片，VR 技术并不适合拍电影</span></a></div>
                       </div>
                   </div>
               </div>
           </div>
           <a href="javascript:;" class="read-more">更多精彩内容可在知乎日报应用中查看</a></div>
   </div>
   <div class="footer">
       <div class="container-fixed-width">
           <div class="qr-bottom">
               <div class="qr-frame"><img src="/img/new_home_v3/qr_bottom.png"></div>
               <div class="tip">扫描下载客户端</div>
           </div>
           <div class="info-wrap"><p>知乎日报是一款拥有千万用户的资讯类客户端，每日提供来自知乎社区的精选问答，还有国内一流媒体的专栏特稿。</p>
               <p>主题日报包括动漫、设计、大公司、游戏、财经、电影、电子音乐、互联网安全等丰富内容，为业内人和资深爱好<br>者推荐各领域最精彩文章，满足高质量阅读需求。</p>
               <p>在知乎日报，告别浮躁，重获阅读的愉悦。</p>
               <p>© 2017 知乎</p></div>
       </div>
   </div>
   <script src="http://static.daily.zhihu.com/js/zepto.min.js"></script>
   <script src="/js/new_home.js"></script>
   <script src="http://wandoujia.com/api/wdapi.js"></script>
   <script src="http://zs.91.com/script/api/key121121.js"></script>
   </body>
   </html>
   ```

3. 查看如上打印的 `HTML` 代码，如果要获取所有数据图片。就要找到对应的 `img` ，取到其对应的 `src` 。

   接下来，依赖于 `cheerio` 对 `HTML` 进行解析来获取所有图片的src。

   代码具体如下:

   ```
   var request = require('request')
   var cheerio = require('cheerio')
   request.get('http://daily.zhihu.com/', function (error, response, body) {
       if (error) return
       var $ = cheerio.load(body)
       $('img').each(function (index, element) {
           console.log($(element).attr('src'))
       })
   })
   ```

   图片地址，打印结果如下图:

   ![](http://otuabc0ck.bkt.clouddn.com/learning-nodejs/14/image/png/static-spider-all-img.png)

4. 接下来，从获取到的数据中发现，有部分图片并不是我们需要的内容。

   因此，筛选我们所需要的图片地址。

   代码如下:

   ```
   $('.link-button img').each(function (index, element) {
           console.log($(element).attr('src'))
   })
   ```

   筛选结果:

   ![](http://otuabc0ck.bkt.clouddn.com/learning-nodejs/14/image/png/static-spider-result-img.png)

   5. 数据筛选过后，就可以将数据内容进行打包存储了。例如保存到数组中，或者通过 `node` 下载到本地。

      先将结果整理成数组

      ```
      var $ = cheerio.load(body)
      var imgSrcArray = []
      $('.link-button img').each(function (index, element) {
           var img = {
             imgSrc: $(element).attr('src')
           }
           imgSrcArray.push(img)
      })
      console.log(imgSrcArray)
      ```

      打印结果，如下图所示:

      ![](http://otuabc0ck.bkt.clouddn.com/learning-nodejs/14/image/png/static-spider-img-array.png)

      接下来，使用 `request` 将图片地址下载并保存在工程目录中。

   6. 新建一个 `download.js` 文件

      ```
      touch download.js
      ```

      在 `download.js` 文件中编写如下代码

      ```
      var path = require('path')
      var fs = require('fs')
      var request = require('request')

      // 下载函数
      // 参数1: 要下载内容的地址
      // 参数2: 要保存的文件夹名
      // 参数3: 要保存的文件名
      function download(url, directory, filename) {
          // 根据当前目录生成文件夹目录
          var dir = path.join(__dirname, directory)
          // 判断文件夹是否存在
          var isDir = fs.existsSync(dir)
          // 不存在, 创建
          if (!isDir) {
              fs.mkdir(dir)
          }
          // 生成保存文件路径
          var filePath = path.join(dir, filename)
          // 下载并保存
          request(url).pipe(fs.createWriteStream(filePath))
      }

      module.exports = download
      ```

   7. 使用 `download.js` 下载我们所获取到的图片

      具体实现步骤如下:

      (1) 引入刚创建好的 `download.js`

      ```
      var download = require('./download')
      ```

      (2) 通过 `download.js` 下载图片

      ```
      imgSrcArray.forEach(function (item, index) {
         download(item.imgSrc, 'images', index + '.jpg')
      })
      ```

      (3) 使用 `node` 执行 `spider.js`

      ```
      node spider.js
      ```

      (4) 查看项目目录，会多出一个 `images` 文件目录

      ![](http://otuabc0ck.bkt.clouddn.com/learning-nodejs/14/image/png/final-img.png)

      ​



